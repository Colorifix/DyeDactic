## DyeDactic: learning colours
--- -
[![License: AGPL v3](https://img.shields.io/badge/License-AGPL_v3-blue.svg)](https://www.gnu.org/licenses/agpl-3.0)

A colour prediction workflow for biosynthetically produced dyes and pigments.  
A code repository to reproduce the results published by [Karlov et al.]()

## Command line set up
- [Poetry](https://python-poetry.org/docs/#installing-with-the-official-installer) is required to run the package I used version (1.8.3)
- Clone the repo `git clone git@github.com:dkarlov/dydactic.git`
- Download a release of XTB executable (6.6.1 was tested) and make sure executable is in your $PATH
- Make sure you are in the root directory `cd dyedactic`
- Please run `poetry install` to install dependencies
- Then any script can be launched using `poetry run python /path/to/script.py`

## Description of package files
### Data and source files
- `tests/spectrum2colour` - several experimental absorption spectrum of several anthraquinone, indigo, and biliverdin derivatives
- `src/` - directory contains all functions and classes from 3D structure generation to colour estimation. 
- `src/convert_spectrum_to_colour.py` - contains functions to convert absorption spectra to RGB colours together with a test run
- `src/optimize_xtb.py` - has wrapping functions to use XTB external program to optimise geometry, calculate energies, and HOMO-LUMO gaps  
- `src/orca_inputs.py` - a class for generating ORCA (5.0.3) input files to optimise geometry and do TD-DFT calculations 
- `src/tauromers.py` - tautomer enumeration functions which use euristics to prune tautomer generation tree and estimate energies using XTB energies
- `src/utils.py` - miscellaneous helper functions
- `data/` - contains the collected data set of natural colourants, calculated QM descriptors, TD-DFT results, and experimental absorption spectra 
- `data/pigments.csv` - a csv file containing the database of collected natural compounds with experimental data and references
- `data/tddft_results.csv` - a csv file containing TD-DFT calculation results including electron transition energy and oscillator strength parsed of ORCA OUTPUTS
- `data/orbital_energies.csv` - a csv file containing quantum chemical descriptors (HOMO, LUMO energies, dipole moments, etc) to train a composite QC/ML model
- `data/pigment_pH_SI.csv` - contains experimental absorption spectra for 4 colourants explored in the paper (*emodin*, *quinalizarin*, *biliverdin*, and *orcein*) at different pH levels
- `figs/` - a folder for Figures generated by scripts in the package
- `inputs/` - generated input files for ORCA calculations
- `mpnn_training/` - a specified folder for chemprop based neural network model to predict absorption lowest light absorption energies
- `mpnn_training/data/` - a directory for raw and clean training data 
- `mpnn_training/data/` - a directory for raw and clean training data 
- `mpnn_training/data/20210205_all_expt_data_no_duplicates_solvent_calcs.csv` - a training set provided by Greenman et al.
- `mpnn_training/data/pigments_wb97xd4_tda_solv.csv` - a csv file with calculated transition energies (wB97XD4) for outlier deletion and solvents in SMILES format 
- `mpnn_training/data/train_all.csv` - a csv file for MPNN training data (90% of natural and 90% of artificial colourants together after split) set with transitions and solvent
- `mpnn_training/data/test_artificial.csv` - a validation set consisted of the artificial colourants (10% of the initial set) to select the best model parameters
- `mpnn_training/data/test_natural.csv` - a natural colourant test set (10% of the collected set) solely to estimate prediction error
- `mpnn_training/data/preds_artificial_....csv` - prediction results for the validation set using a single MPNN trained on the best found parameter set
- `mpnn_training/data/preds_natural_....csv`- prediction results for the natural colourant set using a single MPNN trained on the best found parameter set
- `mpnn_training/data/preds_natural_fold?_....csv`- prediction results for the natural colourant set using an ensemble of models trained during 5-fold CV
- `mpnn_training/hyperopt` - parameters and NN weights
- `mpnn_training/chemprop_hyperopt.py` a script to run hyperparameter optimisation (training is done using GPU)
- `mpnn_training/predict.py` - a prediction script which runs with test_natural.csv by default
- `mpnn_training/visualize_training.py` - prepare a Figure visualising training process prediction performance for paper
- `mpnn_training/prepare_dataset.ipynb` - prepare a train/test spilt for MPNN training and clean the initial data from outliers
- `tests` - spectra in csv format for colour generation tests

### Scripts for image generation and input preparation
- `biliverdin_colour_vs_pH.py` - a script for *biliverdin* halochromicity visualisation based pKa, transition energies and oscillator strengths 
- `emodin_colour_vs_pH.py` - a script for *emodin* halochromicity visualisation based pKa, transition energies and oscillator strengths 
- `quinalizarin_colour_vs_pH.py` - a script for *quinalizarin* halochromicity visualisation based pKa, transition energies and oscillator strengths 
- `orcein_colour_vs_pH.py` - a script for *orcein* halochromicity visualisation based pKa, transition energies and oscillator strengths 
- `generate_inputs.py` - a script to generate inputs files for ORCA and xyz coordinates
- `ground_state_linear_model.py` - training performance visualisation of a linear model based on ground state quantum descriptors (HOMO, LUMO, electrophilicty, hardness, etc.)
- `plot_experimental_spectra_SI.py` - takes experimental spectra in csv format, prints, and converts to corresponding colours 
- `draw_pie_diagram.py` - draws a diagram describing pigment classes collected in this works
- `tddft_energy_correlation_in_groups.py` - creates two tables: MAE vs DFT functional and Pearson vs DFT functional for each class of pigments 
- `tddft_energy_correlation_manuscript_figures.py` - visualise correlation between experimental and calculated using wPBEPP86 transition energies and detected outliers
- `tddft_energy_correlation_SI_figures.py` - visualise correlation between experimental and calculated transition energies for all techniques (SI)
- `tsne_natural_visualize.py` - t-SNE visualisation of the collected database using Morgan fingerprints
- `tddft_fosc_in_groups.py` - A table of Pearson r for oscillator strength for groups of colourants
- `tddft_fosc_SI_figures.py` - Figures for correlation plot for oscillator strength vs extinction coefficients for SI
- `calculate_hlgap.py` - calculates HOMO-LUMO gap on the GFN2-xTB level for precalculated conformations of natural colourants
- `visualize_hlgap.py` - Baseline correlation for HOMO-LUMO gap (GFN2-xTB) and experimental transition energies